<!-- templates/trailer_report.html -->
{% extends "base.html" %}

{% block page_title %}Trailer Report - {{ trailer.trailer_number }}{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{{ url_for('search') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Search
    </a>
    <button class="btn btn-primary" onclick="printReport()">
        <i class="fas fa-print"></i> Print Report
    </button>
    <button class="btn btn-success" onclick="exportReport()">
        <i class="fas fa-file-excel"></i> Export
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Trailer Information Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trailer"></i> Trailer Information
                    </h5>
                    <span class="badge bg-light text-dark fs-6">{{ trailer.trailer_number }}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="info-item">
                            <strong><i class="fas fa-hashtag text-primary"></i> Trailer Number:</strong><br>
                            <span class="h5 text-primary">{{ trailer.trailer_number }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <strong><i class="fas fa-tags text-success"></i> Type:</strong><br>
                            <span class="badge bg-primary fs-6">{{ trailer.type }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <strong><i class="fas fa-industry text-info"></i> Make/Year:</strong><br>
                            {{ trailer.make }} {{ trailer.year }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <strong><i class="fas fa-circle text-{{ 'success' if trailer.status == 'Available' else 'info' if trailer.status == 'Assigned' else 'warning' if trailer.status == 'Maintenance' else 'secondary' }}"></i> Status:</strong><br>
                            <span class="badge bg-{{ 'success' if trailer.status == 'Available' else 'info' if trailer.status == 'Assigned' else 'warning' if trailer.status == 'Maintenance' else 'secondary' }} fs-6">
                                {{ trailer.status }}
                            </span>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-4">
                        <div class="info-item">
                            <strong><i class="fas fa-weight text-warning"></i> Capacity:</strong><br>
                            {{ trailer.capacity or 'Not specified' }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <strong><i class="fas fa-truck text-primary"></i> Assigned Truck:</strong><br>
                            {% if trailer.assigned_truck %}
                                <span class="text-primary">{{ trailer.assigned_truck }}</span>
                            {% else %}
                                <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <strong><i class="fas fa-calendar-alt text-info"></i> Created:</strong><br>
                            {{ trailer.created_at[:10] if trailer.created_at else 'N/A' }}
                        </div>
                    </div>
                </div>

                <!-- Inspection Information -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="info-item">
                            <strong><i class="fas fa-search text-success"></i> Last Inspection:</strong><br>
                            {% if trailer.last_inspection %}
                                {{ trailer.last_inspection }}
                            {% else %}
                                <span class="text-muted">No inspection recorded</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <strong><i class="fas fa-calendar-check text-warning"></i> Next Inspection Due:</strong><br>
                            {% if trailer.next_inspection_due %}
                                <span class="{% if trailer.next_inspection_due < '2025-02-01' %}text-danger{% elif trailer.next_inspection_due < '2025-04-01' %}text-warning{% else %}text-success{% endif %}">
                                    {{ trailer.next_inspection_due }}
                                </span>
                            {% else %}
                                <span class="text-muted">Not scheduled</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if trailer.notes %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="info-item">
                            <strong><i class="fas fa-sticky-note text-secondary"></i> Notes:</strong><br>
                            <div class="text-muted">{{ trailer.notes }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Cost and Statistics Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card card-metric-info h-100">
            <div class="card-body text-center">
                <i class="fas fa-tools fa-2x mb-2 opacity-75"></i>
                <h5 class="mb-1">Maintenance Cost</h5>
                <h3 class="text-white">${{ "{:,.2f}".format(totals.maintenance) }}</h3>
                <small>{{ maintenance|length }} record{{ 's' if maintenance|length != 1 else '' }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-metric-success h-100">
            <div class="card-body text-center">
                <i class="fas fa-wrench fa-2x mb-2 opacity-75"></i>
                <h5 class="mb-1">Shop Work Cost</h5>
                <h3 class="text-white">${{ "{:,.2f}".format(totals.shop) }}</h3>
                <small>{{ shop_jobs|length }} job{{ 's' if shop_jobs|length != 1 else '' }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-metric h-100">
            <div class="card-body text-center">
                <i class="fas fa-calculator fa-2x mb-2 opacity-75"></i>
                <h5 class="mb-1">Total Cost</h5>
                <h3 class="text-white">${{ "{:,.2f}".format(totals.total) }}</h3>
                <small>All maintenance & repairs</small>
            </div>
        </div>
    </div>
</div>

<!-- Activity Timeline -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0"><i class="fas fa-timeline text-primary"></i> Activity Timeline</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% set all_events = [] %}

                    <!-- Combine all events for timeline -->
                    {% for record in maintenance %}
                        {% set _ = all_events.append({
                            'date': record.date,
                            'type': 'maintenance',
                            'title': record.maintenance_type,
                            'description': record.description,
                            'cost': record.total_cost,
                            'shop': record.shop_name,
                            'icon': 'fas fa-tools',
                            'color': 'primary'
                        }) %}
                    {% endfor %}

                    {% for job in shop_jobs %}
                        {% set _ = all_events.append({
                            'date': job.date_started,
                            'type': 'shop_job',
                            'title': job.job_type,
                            'description': job.description,
                            'cost': job.total_cost,
                            'technician': job.technician,
                            'status': job.status,
                            'icon': 'fas fa-wrench',
                            'color': 'success'
                        }) %}
                    {% endfor %}

                    <!-- Add inspection events -->
                    {% if trailer.last_inspection %}
                        {% set _ = all_events.append({
                            'date': trailer.last_inspection,
                            'type': 'inspection',
                            'title': 'DOT Inspection',
                            'description': 'Annual DOT safety inspection',
                            'cost': 0,
                            'status': 'Passed',
                            'icon': 'fas fa-search',
                            'color': 'info'
                        }) %}
                    {% endif %}

                    {% if all_events %}
                        {% for event in all_events|sort(attribute='date', reverse=true) %}
                        <div class="timeline-item">
                            <div class="timeline-marker">
                                <i class="{{ event.icon }} text-{{ event.color }}"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h6 class="mb-1">{{ event.title }}</h6>
                                    <small class="text-muted">{{ event.date }}</small>
                                </div>
                                <div class="timeline-body">
                                    <p class="mb-1">{{ event.description }}</p>
                                    {% if event.cost > 0 %}
                                        <span class="badge bg-{{ event.color }}">Cost: ${{ "{:.2f}".format(event.cost) }}</span>
                                    {% endif %}
                                    {% if event.shop %}
                                        <span class="badge bg-secondary">{{ event.shop }}</span>
                                    {% endif %}
                                    {% if event.technician %}
                                        <span class="badge bg-info">{{ event.technician }}</span>
                                    {% endif %}
                                    {% if event.status %}
                                        <span class="badge bg-success">{{ event.status }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h6>No Activity Records</h6>
                            <p class="text-muted">No maintenance or repair activities recorded for this trailer.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Records Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button">
                            <i class="fas fa-tools"></i> Maintenance Records ({{ maintenance|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="shop-jobs-tab" data-bs-toggle="tab" data-bs-target="#shop-jobs" type="button">
                            <i class="fas fa-wrench"></i> Shop Jobs ({{ shop_jobs|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button">
                            <i class="fas fa-chart-bar"></i> Summary & Analytics
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="reportTabsContent">
                    <!-- Maintenance Records Tab -->
                    <div class="tab-pane fade show active" id="maintenance" role="tabpanel">
                        {% if maintenance %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="fas fa-calendar"></i> Date</th>
                                        <th><i class="fas fa-cog"></i> Type</th>
                                        <th><i class="fas fa-file-alt"></i> Description</th>
                                        <th><i class="fas fa-store"></i> Shop</th>
                                        <th><i class="fas fa-user"></i> Technician</th>
                                        <th><i class="fas fa-dollar-sign"></i> Cost</th>
                                        <th><i class="fas fa-flag"></i> Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in maintenance %}
                                    <tr>
                                        <td>{{ record.date }}</td>
                                        <td>
                                            <span class="badge bg-primary">{{ record.maintenance_type }}</span>
                                        </td>
                                        <td>
                                            <div class="maintenance-description" title="{{ record.description }}">
                                                {{ record.description[:60] }}{% if record.description|length > 60 %}...{% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ record.shop_name }}</strong>
                                            {% if record.shop_location %}
                                                <br><small class="text-muted">{{ record.shop_location }}</small>
                                            {% endif %}
                                        </td>
                                        <td>{{ record.technician or 'N/A' }}</td>
                                        <td>
                                            <strong>${{ "{:.2f}".format(record.total_cost) }}</strong>
                                            {% if record.parts_cost > 0 or record.labor_cost > 0 %}
                                                <br>
                                                <small class="text-muted">
                                                    P: ${{ "{:.0f}".format(record.parts_cost) }} |
                                                    L: ${{ "{:.0f}".format(record.labor_cost) }}
                                                </small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if record.status == 'Completed' else 'warning' if record.status == 'In Progress' else 'secondary' }}">
                                                {{ record.status }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="5" class="text-end"><strong>Total Maintenance Cost:</strong></td>
                                        <td><strong>${{ "{:,.2f}".format(totals.maintenance) }}</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                            <h6>No Maintenance Records</h6>
                            <p class="text-muted">No maintenance activities have been recorded for this trailer.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Shop Jobs Tab -->
                    <div class="tab-pane fade" id="shop-jobs" role="tabpanel">
                        {% if shop_jobs %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="fas fa-calendar"></i> Date Started</th>
                                        <th><i class="fas fa-cog"></i> Job Type</th>
                                        <th><i class="fas fa-file-alt"></i> Description</th>
                                        <th><i class="fas fa-user"></i> Technician</th>
                                        <th><i class="fas fa-clock"></i> Labor Hours</th>
                                        <th><i class="fas fa-dollar-sign"></i> Cost</th>
                                        <th><i class="fas fa-flag"></i> Status</th>
                                        <th><i class="fas fa-exclamation"></i> Priority</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in shop_jobs %}
                                    <tr>
                                        <td>
                                            {{ job.date_started }}
                                            {% if job.date_completed %}
                                                <br><small class="text-success">Completed: {{ job.date_completed }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ job.job_type }}</span>
                                        </td>
                                        <td>
                                            <div class="job-description" title="{{ job.description }}">
                                                {{ job.description[:60] }}{% if job.description|length > 60 %}...{% endif %}
                                            </div>
                                        </td>
                                        <td>{{ job.technician }}</td>
                                        <td>{{ job.labor_hours }}h</td>
                                        <td>
                                            <strong>${{ "{:.2f}".format(job.total_cost) }}</strong>
                                            {% if job.parts_cost > 0 or job.labor_cost > 0 %}
                                                <br>
                                                <small class="text-muted">
                                                    P: ${{ "{:.0f}".format(job.parts_cost) }} |
                                                    L: ${{ "{:.0f}".format(job.labor_cost) }}
                                                </small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if job.status == 'Completed' else 'warning' if job.status == 'In Progress' else 'info' if job.status == 'Scheduled' else 'secondary' }}">
                                                {{ job.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if job.priority == 'Critical' else 'warning' if job.priority == 'High' else 'info' if job.priority == 'Medium' else 'secondary' }}">
                                                {{ job.priority }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="5" class="text-end"><strong>Total Shop Job Cost:</strong></td>
                                        <td><strong>${{ "{:,.2f}".format(totals.shop) }}</strong></td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-wrench fa-3x text-muted mb-3"></i>
                            <h6>No Shop Jobs</h6>
                            <p class="text-muted">No shop work has been performed on this trailer.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Summary & Analytics Tab -->
                    <div class="tab-pane fade" id="summary" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-pie text-primary"></i> Cost Breakdown</h6>
                                <div class="mb-3">
                                    {% if totals.total > 0 %}
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Maintenance:</span>
                                        <span><strong>${{ "{:,.2f}".format(totals.maintenance) }}</strong> ({{ "%.1f"|format(totals.maintenance / totals.total * 100) }}%)</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 8px;">
                                        <div class="progress-bar bg-primary" style="width: {{ totals.maintenance / totals.total * 100 }}%"></div>
                                    </div>

                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Shop Jobs:</span>
                                        <span><strong>${{ "{:,.2f}".format(totals.shop) }}</strong> ({{ "%.1f"|format(totals.shop / totals.total * 100) }}%)</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 8px;">
                                        <div class="progress-bar bg-success" style="width: {{ totals.shop / totals.total * 100 }}%"></div>
                                    </div>
                                    {% else %}
                                    <p class="text-muted">No cost data available</p>
                                    {% endif %}
                                </div>

                                <h6><i class="fas fa-calendar text-info"></i> Activity Summary</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-tools text-primary"></i> {{ maintenance|length }} maintenance record{{ 's' if maintenance|length != 1 else '' }}</li>
                                    <li><i class="fas fa-wrench text-success"></i> {{ shop_jobs|length }} shop job{{ 's' if shop_jobs|length != 1 else '' }}</li>
                                    <li><i class="fas fa-calendar-check text-info"></i>
                                        {% if trailer.next_inspection_due %}
                                            Next inspection: {{ trailer.next_inspection_due }}
                                        {% else %}
                                            No inspection scheduled
                                        {% endif %}
                                    </li>
                                </ul>
                            </div>

                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle text-secondary"></i> Trailer Details</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Trailer Number:</strong></td>
                                            <td>{{ trailer.trailer_number }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Type:</strong></td>
                                            <td>{{ trailer.type }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Make/Year:</strong></td>
                                            <td>{{ trailer.make }} {{ trailer.year }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Capacity:</strong></td>
                                            <td>{{ trailer.capacity or 'Not specified' }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Status:</strong></td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if trailer.status == 'Available' else 'info' if trailer.status == 'Assigned' else 'warning' }}">
                                                    {{ trailer.status }}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Assigned Truck:</strong></td>
                                            <td>{{ trailer.assigned_truck or 'Unassigned' }}</td>
                                        </tr>
                                    </table>
                                </div>

                                {% if totals.total > 0 %}
                                <div class="alert alert-info">
                                    <i class="fas fa-calculator"></i>
                                    <strong>Total Investment:</strong> ${{ "{:,.2f}".format(totals.total) }}
                                    <br>
                                    <small>Total maintenance and repair costs to date</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.info-item {
    margin-bottom: 1rem;
}

.card-metric, .card-metric-success, .card-metric-info {
    transition: transform 0.2s ease-in-out;
}

.card-metric:hover, .card-metric-success:hover, .card-metric-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    top: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    border: 2px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
}

.timeline-content {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #007bff;
}

.timeline-header {
    margin-bottom: 10px;
}

.maintenance-description, .job-description {
    cursor: help;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}

.progress {
    height: 8px;
    border-radius: 4px;
}

.badge {
    font-size: 0.75em;
}

@media print {
    .btn-group, .card-header .nav-tabs {
        display: none !important;
    }

    .card {
        border: 1px solid #ddd !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function printReport() {
    window.print();
}

function exportReport() {
    // In a real implementation, this would generate an Excel file
    alert('Export functionality would generate an Excel report with all trailer data');
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Add smooth scrolling to tab changes
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function(e) {
            // Smooth scroll to top of tab content
            document.querySelector('.card-body').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        });
    });
});

// Highlight inspection due dates
document.addEventListener('DOMContentLoaded', function() {
    const inspectionDue = document.querySelector('[class*="text-danger"], [class*="text-warning"]');
    if (inspectionDue && inspectionDue.textContent.includes('2025')) {
        const dueDate = new Date(inspectionDue.textContent.trim());
        const today = new Date();
        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

        if (daysUntilDue < 30 && daysUntilDue > 0) {
            inspectionDue.innerHTML += ` <small class="badge bg-warning">${daysUntilDue} days</small>`;
        } else if (daysUntilDue <= 0) {
            inspectionDue.innerHTML += ` <small class="badge bg-danger">Overdue</small>`;
        }
    }
});
</script>
{% endblock %}