<!-- templates/dashboard.html -->
{% extends "base.html" %}

{% block content %}
<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-metric h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Total Drivers</div>
                        <div class="h5 mb-0 font-weight-bold">{{ stats.total_drivers }}</div>
                        <small>CD Drivers: {{ stats.cd_drivers }}</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-metric-success h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Total Trucks</div>
                        <div class="h5 mb-0 font-weight-bold">{{ stats.total_trucks }}</div>
                        <small>Active: {{ stats.active_trucks }}</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-truck fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-metric-info h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Total Trailers</div>
                        <div class="h5 mb-0 font-weight-bold">{{ stats.total_trailers }}</div>
                        <small>Available: {{ stats.available_trailers }}</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-trailer fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-metric-warning h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Open OTR Cases</div>
                        <div class="h5 mb-0 font-weight-bold">{{ stats.open_otr }}</div>
                        <small>{% if stats.open_otr > 0 %}Needs attention{% else %}All clear{% endif %}</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overview Cards Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0"><i class="fas fa-chart-bar text-primary"></i> Maintenance Overview</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <div class="p-2">
                            <h6 class="text-muted mb-1">Total Records</h6>
                            <p class="h4 text-primary mb-0">{{ stats.total_maintenance }}</p>
                            <small class="text-muted">All maintenance</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2">
                            <h6 class="text-muted mb-1">PM Records</h6>
                            <p class="h4 text-success mb-0">{{ stats.total_pm }}</p>
                            <small class="text-muted">Preventive maintenance</small>
                        </div>
                    </div>
                </div>
                <hr class="my-3">
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <div class="p-2">
                            <h6 class="text-muted mb-1">Shop Jobs</h6>
                            <p class="h4 text-info mb-0">{{ stats.shop_jobs }}</p>
                            <small class="text-muted">In-house work</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2">
                            <h6 class="text-muted mb-1">OTR Cases</h6>
                            <p class="h4 text-warning mb-0">{{ stats.open_otr }}</p>
                            <small class="text-muted">Road repairs</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0"><i class="fas fa-dollar-sign text-success"></i> Cost Overview</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <div class="p-2">
                            <h6 class="text-muted mb-1">Maintenance Cost</h6>
                            <p class="h4 text-primary mb-0">${{ "{:,.2f}".format(stats.total_maintenance_cost) }}</p>
                            <small class="text-muted">Regular maintenance</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2">
                            <h6 class="text-muted mb-1">OTR Cost</h6>
                            <p class="h4 text-danger mb-0">${{ "{:,.2f}".format(stats.total_otr_cost) }}</p>
                            <small class="text-muted">Emergency repairs</small>
                        </div>
                    </div>
                </div>
                <hr class="my-3">
                <div class="text-center">
                    <h6 class="text-muted mb-1">Total Maintenance Cost</h6>
                    <p class="h3 text-dark mb-0">${{ "{:,.2f}".format(stats.total_maintenance_cost + stats.total_otr_cost) }}</p>
                    <small class="text-muted">Year to date</small>
                </div>

                <!-- Cost breakdown progress bar -->
                {% set total_cost = stats.total_maintenance_cost + stats.total_otr_cost %}
                {% if total_cost > 0 %}
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="text-muted">Cost Breakdown</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                             style="width: {{ (stats.total_maintenance_cost / total_cost * 100)|round(1) }}%"
                             title="Maintenance: {{ (stats.total_maintenance_cost / total_cost * 100)|round(1) }}%"></div>
                        <div class="progress-bar bg-danger" role="progressbar"
                             style="width: {{ (stats.total_otr_cost / total_cost * 100)|round(1) }}%"
                             title="OTR: {{ (stats.total_otr_cost / total_cost * 100)|round(1) }}%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-primary">{{ (stats.total_maintenance_cost / total_cost * 100)|round(1) }}% Maintenance</small>
                        <small class="text-danger">{{ (stats.total_otr_cost / total_cost * 100)|round(1) }}% OTR</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions and Recent Activity -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0"><i class="fas fa-bolt text-warning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6 col-lg-3">
                        <a href="{{ url_for('add_driver') }}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-user-plus fa-2x mb-2"></i>
                            <span>Add Driver</span>
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <a href="{{ url_for('add_truck') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-truck fa-2x mb-2"></i>
                            <span>Add Truck</span>
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <a href="{{ url_for('add_otr') }}" class="btn btn-outline-warning w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-tools fa-2x mb-2"></i>
                            <span>Add OTR Repair</span>
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <a href="{{ url_for('add_pm') }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-calendar-plus fa-2x mb-2"></i>
                            <span>Add PM Record</span>
                        </a>
                    </div>
                </div>

                <hr class="my-4">

                <div class="row g-3">
                    <div class="col-md-6 col-lg-3">
                        <a href="{{ url_for('add_trailer') }}" class="btn btn-outline-secondary w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-trailer fa-2x mb-2"></i>
                            <span>Add Trailer</span>
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <a href="{{ url_for('add_shop_job') }}" class="btn btn-outline-dark w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-wrench fa-2x mb-2"></i>
                            <span>Add Shop Job</span>
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <a href="{{ url_for('search') }}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <span>Search Records</span>
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <a href="{{ url_for('export_data') }}" class="btn btn-outline-secondary w-100 h-100 d-flex flex-column justify-content-center">
                            <i class="fas fa-download fa-2x mb-2"></i>
                            <span>Export Data</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0"><i class="fas fa-bell text-warning"></i> System Alerts</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Welcome to TMS!</strong> Your truck maintenance management system is ready to use.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                {% if stats.open_otr > 0 %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>{{ stats.open_otr }} Open OTR Case{{ 's' if stats.open_otr > 1 else '' }}</strong><br>
                    <small>Requires immediate attention</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endif %}

                {% if stats.total_trucks == 0 %}
                <div class="alert alert-primary alert-dismissible fade show" role="alert">
                    <i class="fas fa-truck me-2"></i>
                    <strong>Get Started!</strong><br>
                    <small>Add your first truck to begin tracking maintenance.</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endif %}

                <div class="mt-3">
                    <h6 class="text-muted">Quick Stats</h6>
                    <ul class="list-unstyled">
                        <li class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-circle text-success me-2"></i>Active Trucks</span>
                            <strong>{{ stats.active_trucks }}</strong>
                        </li>
                        <li class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-circle text-info me-2"></i>Available Trailers</span>
                            <strong>{{ stats.available_trailers }}</strong>
                        </li>
                        <li class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-circle text-primary me-2"></i>CD Drivers</span>
                            <strong>{{ stats.cd_drivers }}</strong>
                        </li>
                        <li class="d-flex justify-content-between">
                            <span><i class="fas fa-circle text-secondary me-2"></i>Total Records</span>
                            <strong>{{ stats.total_maintenance + stats.total_pm + stats.shop_jobs }}</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fleet Status Overview -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0"><i class="fas fa-chart-pie text-info"></i> Fleet Status Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-muted mb-3">Truck Status Distribution</h6>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Active Trucks</small>
                                <small>{{ stats.active_trucks }}/{{ stats.total_trucks }}</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" role="progressbar"
                                     style="width: {% if stats.total_trucks > 0 %}{{ (stats.active_trucks / stats.total_trucks * 100)|round(1) }}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Available Trailers</small>
                                <small>{{ stats.available_trailers }}/{{ stats.total_trailers }}</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-info" role="progressbar"
                                     style="width: {% if stats.total_trailers > 0 %}{{ (stats.available_trailers / stats.total_trailers * 100)|round(1) }}%{% else %}0%{% endif %}"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <h6 class="text-muted mb-3">Maintenance Activity</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h5 text-primary mb-0">{{ stats.total_maintenance }}</div>
                                    <small class="text-muted">Total Maintenance</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h5 text-success mb-0">{{ stats.total_pm }}</div>
                                    <small class="text-muted">PM Records</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <h6 class="text-muted mb-3">Cost Summary</h6>
                        <div class="text-center">
                            <div class="h4 text-success mb-1">${{ "{:,.0f}".format(stats.total_maintenance_cost + stats.total_otr_cost) }}</div>
                            <small class="text-muted">Total Maintenance Cost</small>
                            <div class="mt-2">
                                {% if stats.total_trucks > 0 %}
                                <small class="text-muted">
                                    Avg per truck: ${{ "{:,.0f}".format((stats.total_maintenance_cost + stats.total_otr_cost) / stats.total_trucks) }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card-metric, .card-metric-success, .card-metric-warning, .card-metric-info {
    transition: transform 0.2s ease-in-out;
}

.card-metric:hover, .card-metric-success:hover, .card-metric-warning:hover, .card-metric-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.quick-action-btn {
    min-height: 80px;
    transition: all 0.2s ease-in-out;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}

.alert {
    border-left: 4px solid;
}

.alert-info {
    border-left-color: #17a2b8;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-primary {
    border-left-color: #007bff;
}

.opacity-75 {
    opacity: 0.75;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh dashboard data every 5 minutes
setInterval(function() {
    // In a production environment, you might want to refresh certain data via AJAX
    console.log('Dashboard auto-refresh interval');
}, 300000); // 5 minutes

// Initialize tooltips for progress bars
document.addEventListener('DOMContentLoaded', function() {
    // Add tooltips to progress bars
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Animate counters on page load
    animateCounters();
});

function animateCounters() {
    const counters = document.querySelectorAll('.h5, .h4, .h3');
    counters.forEach(counter => {
        const text = counter.textContent;
        const number = parseInt(text.replace(/[^0-9]/g, ''));
        if (!isNaN(number) && number > 0) {
            animateValue(counter, 0, number, 1000);
        }
    });
}

function animateValue(element, start, end, duration) {
    if (start === end) return;
    const increment = end > start ? 1 : -1;
    const stepTime = Math.abs(Math.floor(duration / (end - start)));
    let current = start;

    const timer = setInterval(() => {
        current += increment;
        const originalText = element.textContent;
        const prefix = originalText.match(/^[^0-9]*/)[0];
        const suffix = originalText.match(/[^0-9]*$/)[0];
        element.textContent = prefix + current.toLocaleString() + suffix;

        if (current === end) {
            clearInterval(timer);
        }
    }, stepTime);
}

// Add click analytics (optional)
document.querySelectorAll('.btn').forEach(button => {
    button.addEventListener('click', function() {
        console.log('Dashboard action:', this.textContent.trim());
    });
});
</script>
{% endblock %}